<!DOCTYPE html>
<head>
  <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
  <style>
  h1 {
    font-family: sans-serif;
  }
  p {
    max-width: 800px;
  }

  #range_search {
    width: 800px;
  }
  </style>
</head>

<h1>Chromium Trybot Flakes</h1>

<p style="color:Red;">
NOTE: Chromium-try-flakes has been deprecated and replaced by <a href='https://findit-for-me.appspot.com/ranked-flakes'>Findit Flake Detector</a> as of 09/20/2018.
</p>

<p>
This dashboard displays steps which failed in a try run but passed in a second
try run for the same patchset.
</p>

<table id="range_search">
<tr><td width="100%">
<select id='range'
        onchange="location = '/?range=' +
          this.options[this.selectedIndex].value;">
  <option value="hour">Last hour</option>
  <option value="day">Last day</option>
  <option value="week">Last week</option>
  <option value="month">Last month</option>
  <option value="all">All time</option>
</select>
</td><td>
<input id="search"
       type="search"
       placeholder="try searching for test name or step name"
       style="width:400px"
       onkeydown="if (event.keyCode == 13) location = '/search?q=' +
         encodeURIComponent(document.getElementById('search').value)">
</td></tr>
</table>
<br>
<br>

<table>
{% for f in flakes %}
<tr>
<td colspan="3">
  <div style=" float: left">
    <span><b>{{f.name}}</b></span>
    <small>(
      <a href="/all_flake_occurrences?key={{f.key.urlsafe}}">
          more occurrences</a>
      {% if f.issue_id > 0 %}
        , <a href="https://crbug.com/{{f.issue_id}}">latest bug</a>
      {% endif %}
      )
    </small>
  </div>
</td>
</tr>
<tr>
<td colspan="3">
  <input id="step_comment_{{forloop.counter}}"
         style="width:100%; "
         data-key="{{f.key.urlsafe}}"
         placeholder="comment"
         type="text" value="{{f.comment}}"
         onblur="PostComment('step_comment_{{forloop.counter}}')">
</td>
</tr>

{% for o in f.filtered_occurrences %}
<tr>
<td><a href="{{o.getURL}}">try run at {{o.formatted_time}} UTC</a></td>
<td><a href="{{o.patchset_url}}">patchset</a></td>
<td>{{o.builder}} </td>
</tr>
{% endfor %}

{% if f.more_occurrences %}
<tr><td colspan="3">
<a href="/all_flake_occurrences?key={{f.key.urlsafe}}">more occurrences</a>
</td></tr>
{% endif %}

<tr><td>&nbsp;</td></tr>
{% endfor %}
</table>

{% if more %}
<a href='/?range={{range}}&cursor={{cursor}}'>next</a>
{% endif %}

<br>
<br>
TODO:
<ul>
<li>compiles are split out by specific failure</li>
<li>failure rates</li>
</ul>


<script>
function UpdateSelectedRange(range) {
  select = document.getElementById('range');
  for (var i = select.options.length; i-- > 0;) {
    if (select.options[i].value == range) {
      select.selectedIndex = i;
      return;
    }
  }
}
UpdateSelectedRange('{{range}}')

function PostComment(id) {
  element = document.getElementById(id);
  comment = element.value;
  key = element.dataset['key'];

  var xhr = new XMLHttpRequest();

  var data = new FormData();
  data.append('key', key);
  data.append('comment', comment);
  xhr.open('POST', '/post_comment');
  xhr.send(data);
}
</script>

<!-- Feedback Button -->
<script>
  (function(i,s,o,g,r,a,m){i['CrDXObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://storage.googleapis.com/crdx-feedback.appspot.com/feedback.js','crdx');

  crdx('setFeedbackButtonLink', 'https://bugs.chromium.org/p/chromium/issues/entry?components=Infra%3EFlakiness%3EPipeline&comment=&labels=Pri-2');
</script>
