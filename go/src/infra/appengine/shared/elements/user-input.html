<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/elements/users-dropdown.html">
<link rel="import" href="/elements/user-id.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/iron-behaviors/iron-control-state.html">

<dom-module id="user-input">
  <template>
    <style>
    </style>
    <paper-input id="input" value="{{inputValue}}" disabled="[[_inputDisabled]]">
      <template is="dom-repeat" items="[[selectedUsers]]">
        <user-id
          slot="prefix"
          user-id="[[item.userId]]"
          email="[[item.email]]"
          profile-link="[[item.profileLink]]"
          full-name="[[item.fullName]]">
        </user-id>
      </template>
    </paper-input>
    <users-dropdown id="dropdown" on-user-selected="_saveUser" suggestions="[[suggestions]]">
    </users-dropdown>
  </template>
  <script>
    'use strict';

    /**
     *
     * `<user-input>` as an input element for choosing users with
     * dropdown suggestions and autocomplete.
     *
     * Provide all possible users as allUsers. The final list of
     * of selected users will be in the selectedUsers property.
     *
     * customElement
     * @polymer
     * @demo /demo/user-input_demo.html
     *
     */
    class UserInput extends Polymer.mixinBehaviors(
        [Polymer.IronControlState], Polymer.Element) {
      static get is() { return 'user-input'; }

      static get properties() {
        return {
          /**
           * The current input value.
           *
           * @type String
           */
          inputValue: {
            type: String,
            value: '',
            notify: true,
          },
          /**
           * List of suggestions displayed in the dropdown.
           *
           * @type Array<Object{userId, email(opt), profileLink(opt), fullName(opt)}>
           */
          suggestions: {
            type: Array,
            value: () => { return []; },
          },
          /**
           * List of users selected, so far.
           *
           * @type Array<Object{userId, email(opt), profileLink(opt), fullName(opt)}>
           */
          selectedUsers: {
            type: Array,
            value: () => { return []; },
          },
          /**
           * If true, multiple users can be selected.
           *
           * @type Boolean
           */
          multiple: {
            type: Boolean,
            value: false,
          },
          /**
           * If true, additional users cannot be selected.
           *
           * @type Boolean
           */
          _inputDisabled: {
            type: Boolean,
            value: false,
          },
        }
      }

      static get observers() {
        return [
          '_updateInputDisabled(selectedUsers.length)'
        ]
      }

      ready() {
        super.ready();
        this.addEventListener('focused-changed', e => this._toggleDropdown(e));
      }

      /** Updates inputDisabled. */
      _updateInputDisabled(length) {
        if (!this.multiple && length) {
          this._inputDisabled = true;
          this.$.dropdown.close();
        }
      }

      /** Toggles the visibility of the dropdown element. */
      _toggleDropdown() {
        this.focused ? this.$.dropdown.open() : this.$.dropdown.close();
      }

      /**
       * Pushes a newly selected user to the selectedUser property
       *
       * @param {Event} e event that triggered the function with selectedUser
       * in the detail{}.
       */
      _saveUser(e) {
        this.push('selectedUsers', e.detail.selectedUser);
      }
    }
    customElements.define(UserInput.is, UserInput);
  </script>
</dom-moduel>
