<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-location/iron-location.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../elements/som-alert-item.html">
<link rel="import" href="../elements/som-annotation-manager-behavior.html">
<link rel="import" href="../elements/som-annotations.html">
<link rel="import" href="../elements/som-bug-queue.html">
<link rel="import" href="../elements/som-drawer.html">
<link rel="import" href="../elements/som-examine.html">
<link rel="import" href="../elements/som-master-restarts.html">
<link rel="import" href="../elements/som-swarming-bots.html">
<link rel="import" href="../elements/som-tree-status.html">
<link rel="import" href="../elements/pages/som-help.html">
<link rel="import" href="../elements/pages/som-rotation-calendar.html">

<dom-module id="som-app">
  <template>
    <style>
      paper-toolbar {
        --paper-toolbar-background: black;
      }
      paper-toolbar a {
        color: #fff;
      }
      paper-header-panel /deep/ #mainContainer {
        @apply(--layout-vertical);
      }
      paper-header-panel[main] {
        --paper-header-panel-body: {
          background: #eee;
        }
      }
      h2, h3 {
        font-weight: bold;
        font-size: 18px;
      }
      .header {
        padding: 0.5em 0.5em 0.2em;
        margin: 1em 0.5em;
        background-color: #eee;
      }
      #alertsList {
        padding: 0;
      }
      #alertsListInner h2 {
        font-size: 22px;
      }
      #examineAlert {
        height: 100%;
      }
      #fetchAlertsError {
        color: #f00;
        margin: 1em;
      }
      #noAlerts {
        text-align: center;
        font-size: 2.5em;
        line-height: 150%;
      }
      #refresh {
        max-width: 30px;
      }
      #refresh paper-icon-button {
        width: 25px;
        height: 25px;
        padding: 0;
      }
      .error {
        color: #c00;
        margin-top: 0;
      }
      .last-updated {
        min-width: 200px;
      }
      .last-updated, .user-name {
        text-align: right;
        padding-right: 1em;
      }
      .list-item {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        margin: 1em;
        border-bottom: 1px solid #ddd;
      }
      .notification {
        box-sizing: border-box;
        width: 100%;
        padding: 8px 10px;
        margin: 5px auto 10px;
        border: 1px solid #666;
        border-radius: 5px;
      }
      .page-body {
        background: white;
        border-left: 1px solid #ddd;
        padding: 1em;
      }
      .category-title {
        padding: 0.5em 0.5em 0.2em;
        margin: 1em 0.5em;
        background-color: #eee;
        border-bottom: 1px solid #ddd;
      }
      .som-title {
        font-weight: bold;
      }
      .som-title img {
        max-width: 30px;
        max-height: 30px;
        vertical-align: middle;
      }
      .title {
        font-size: big;
      }
      @media (max-width: 1024px) {
        .last-updated, .user-name {
          padding-right: 0.5em;
          font-size: 0.9em;
          line-height: 100%;
        }
        .user-name {
          @apply(--layout-flex);
        }
      }
      @media (max-width: 540px) {
        .last-updated, .user-name {
          font-size: 0.8em;
          min-width: 10%;
          text-align: left;
        }
        #fetchingAlerts {
          display: none;
        }
        #tree-title {
          display: none;
        }
      }
    </style>
    <iron-location id="url" path="{{_path}}" url-space-regex="^(?!(/_ah/|/auth/))"></iron-location>
    <paper-drawer-panel responsive-width="1024px">
      <paper-header-panel drawer>
        <paper-toolbar>
          <span class="som-title">
            <template is="dom-if" if="[[_treeLogo]]">
              <a href="/[[_tree]]"><img src="[[_treeLogo]]" alt="[[_tree]]" title="[[_tree]]" /></a>
            </template>
            Sheriff-o-Matic
          </span>
        </paper-toolbar>
        <som-drawer
            id="drawer"
            tree="[[_tree]]"
            path="{{_path}}"
            static-pages="[[_staticPages]]"
            show-infra-failures="{{showInfraFailures}}"
            link-style="{{linkStyle}}"
            trees="{{_trees}}"
            use-compact-view="{{useCompactView}}"
            ></som-drawer>
      </paper-header-panel>
      <paper-header-panel main id="mainHeaderPanel" class="flex layout vertical">
        <paper-toolbar>
          <div class="layout horizontal flex">
            <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
            <div class="flex title" id="tree-title">[[_tree]]</div>
            <div hidden$="[[_lastUpdate]]" class="flex last-updated">
              Last updated: [[_lastUpdated]]
            </div>
            <div class="horizontal user-name">
              [[user]] (<a href$="[[logoutUrl]]">Log Out </a>)
            </div>
            <div id="refresh" class="flex">
              <paper-icon-button on-tap="_refresh" icon="refresh"></paper-icon-button>
            </div>
          </div>
          <paper-spinner id="fetchingAlerts" active="[[_fetchingAlerts]]"></paper-spinner>
        </paper-toolbar>
        <som-annotations id="annotations" annotations="{{annotations}}" bug-queue-label="[[_bugQueueLabel]]"
          local-state="{{localState}}" user="{{user}}" xsrf-token="{{xsrfToken}}"></som-annotations>
        <iron-pages attr-for-selected='id' selected="[[_selectedPage]]" class="flex layout vertical">
          <div id="alertsList" class="page-body">
            <div class="list-item">
              <som-tree-status tree="[[_tree]]" id="treeStatus"></som-tree-status>
              <som-master-restarts tree="[[_tree]]" id="masterRestarts"></som-master-restarts>
              <div class="notification" hidden$="[[_isTrooperPage]]">
                Start at the top and try to clear all the alerts. For additional guidance, see:
                <span hidden="[[!_helpLink]]">
                  <a href="[[_helpLink]]" target="_blank">[[_treeDisplayName]] Help</a>
                </span>
                <span hidden="[[_helpLink]]">
                  <a href="/help-som">The Help Page</a>
                </span>
              </div>
              <div class="notification" hidden$="[[!_isTrooperPage]]">
                Troopers, don't forget to check <a href="http://go/trooper-pagers" target="_blank">go/trooper-pagers</a>
                and <a href="http://go/trooper-alerts" target="_blank">go/trooper-alerts</a> as well.
                For additional guidance, see: <a href="http://go/trooper" target="_blank">The Trooper Playbook</a>
              </div>
            </div>
            <som-bug-queue id="bugQueue" bug-queue-label="[[_bugQueueLabel]]" tree-display-name="[[_treeDisplayName]]"></som-bug-queue>
            <div id="alertsListInner">
              <h2 class="header">[[_treeDisplayName]] Failure Alerts (<a href="/help-som">Help?</a>)</h2>
              <div id="fetchAlertsError" hidden=[[!_fetchAlertsError]]>[[_fetchAlertsError]]</div>
              <template is="dom-if" if="[[!_hideJulie]]">
                <div id="noAlerts">
                  No alerts!
                  <br>
                  <img src="/images/jparent-jump.gif" alt="Julie Jumping" title="Julie Jumping">
                </div>
              </template>
              <template is="dom-repeat" items="[[_computeCategories(_alerts, _isTrooperPage)]]" as="cat">
                <div class="category-title layout horizontal justified">
                  <h3 class="self-center">[[_getCategoryTitle(cat, _isTrooperPage)]]:</h3>
                  <template is="dom-if" if="[[useCompactView]]">
                    <div class="self-center end section-buttons">
                      <paper-button raised on-tap="collapseAll">
                        Collapse all
                      </paper-button>
                      <paper-button raised on-tap="expandAll">
                        Expand all
                      </paper-button>
                    </div>
                  </template>
                </div>
                <template is="dom-repeat" items="[[_alertsWithCategory(_alerts, cat, _isTrooperPage)]]" as="alert">
                  <div class="list-item" tabindex$="[[tabIndex]]">
                    <som-alert-item
                        alert="{{alert}}"
                        tree="[[_tree]]"
                        selected="[[selected]]"
                        annotation="[[computeAnnotation(annotations, alert)]]"
                        link-style="[[linkStyle]]"
                        on-annotation-change="_handleAnnotation"
                        on-comment="_handleComment"
                        on-link-bug="_handleLinkBug"
                        on-snooze="_handleSnooze"
                        on-opened-change="_handleOpenedChange"
                        use-compact-view="[[useCompactView]]"
                    ></som-alert-item>
                  </div>
                </template>
              </template>
              <template is="dom-if" if="[[_showSwarmingAlerts]]">
                <h2 class="header">Swarming Bots (<a target="_blank" href="https://chrome-internal.googlesource.com/infra/infra_internal/+/master/doc/troopers/playbook.md#Swarming">Help?</a>)</h2>
                <som-swarming-bots bots="[[_swarmingAlerts]]"></som-swarming-bots>
              </template>
            </div>
          </div>
          <template is="dom-if" if="[[_examinedAlert]]">
            <div id="examineAlert" class="flex layout vertical page-body">
              <som-alert-item
                  alert="{{_examinedAlert}}"
                  tree="[[_tree]]"
                  annotation="[[computeAnnotation(annotations, _examinedAlert)]]"
                  link-style="[[linkStyle]]"
                  on-annotation-change="_handleAnnotation"
                  on-comment="_handleComment"
                  on-link-bug="_handleLinkBug"
                  on-snooze="_handleSnooze"
                  examining
              ></som-alert-item>
              <som-examine alert="[[_examinedAlert]]" link-style="[[linkStyle]]" class="flex layout vertical"></som-examine>
            </div>
          </template>
          <som-help id="helpSOM" class="page-body"></som-help>
          <template is="dom-if" if="[[_showRotationCalendar]]">
            <som-rotation-calendar id="rotationCalendar" class="flex layout vertical page-body"></som-rotation-calendar>
          </template>
        </iron-pages>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
  (function() {
    'use strict';

    // Time, in milliseconds, between each refresh of data from the server.
    const refreshDelayMs = 60 * 1000;

    Polymer({
      is: 'som-app',
      behaviors: [AnnotationManagerBehavior],
      properties: {
        _activeRequests: {
          type: Number,
          value: 0,
        },
        _alerts: {
          type: Array,
          value: function() { return []; },
          computed: '_computeAlerts(_alertsData.*, annotations, showInfraFailures, _isTrooperPage)',
          observer: '_alertsChanged',
        },
        // Map of stream to data, timestamp of latest updated data.
        _alertsData: {
          type: Object,
          value: function() { return {}; },
        },
        _alertsTimes: {
          type: Object,
          value: function() { return {}; },
        },
        _alertsGroups: {
          type: Array,
          computed: '_computeAlertsGroups(_tree, _trees)',
          observer: '_alertsGroupsChanged',
        },
        annotations: Object,
        _lastUpdated: {
          type: Date,
          computed: '_computeLastUpdated(_alertsTimes.*)',
        },
        _bugQueueLabel: {
          type: Array,
          computed: '_computeBugQueueLabel(_tree, _trees)',
        },
        _fetchAlertsError: String,
        _fetchingAlerts: {
          type: Boolean,
          computed: '_computeFetchingAlerts(_activeRequests)',
        },
        _fetchedAlerts: {
          type: Boolean,
          value: false,
        },
        _hideJulie: {
          type: Boolean,
          computed: '_computeHideJulie(_alerts, _fetchedAlerts, _fetchingAlerts, _fetchAlertsError, _tree)',
          value: true,
        },
        _isTrooperPage: {
          type: Boolean,
          computed: '_computeIsTrooperPage(_tree)',
          value: false,
        },
        logoutUrl: String,
        _path: {
          type: String,
        },
        _helpLink: {
          type: String,
          computed: '_computeHelpLink(_tree, _trees)',
        },
        _refreshEnabled: {
          type: Boolean,
          computed: '_computeRefreshEnabled(_selectedPage)',
        },
        _selectedPage: {
          type: String,
          computed: '_computeSelectedPage(_path)',
        },
        _showRotationCalendar: {
          type: Boolean,
          value: false,
        },
        showInfraFailures: Boolean,
        _showSwarmingAlerts: {
          type: Boolean,
          computed: '_computeShowSwarmingAlerts(_swarmingAlerts)',
        },
        _swarmingAlerts: {
          type: Object,
          value: function() { return {}; },
        },
        _trees: Object,
        _tree: {
          type: String,
          computed: '_computeTree(_path)',
          observer: '_treeChanged',
        },
        _treeDisplayName: {
          type: String,
          computed: '_computeTreeDisplayName(_tree, _trees)',
        },
        _treeLogo: {
          type: String,
          computed: '_computeTreeLogo(_tree, _trees)',
        },
        _staticPages: {
          type: Object,
          value: {
            'help-som': {
              pageId : 'helpSOM',
              displayText : 'How to Use',
            },
            'calendar': {
              pageId: 'rotationCalendar',
              displayText: 'Rotation Calendar',
            }
          },
        },
        _examinedAlert: {
          type: Object,
          computed: '_computeExaminedAlert(_alerts, _examinedAlertKey)',
        },
        _examinedAlertKey: {
          type: String,
          computed: '_computeExaminedAlertKey(_path)',
        },
        user: String,
        useCompactView: Boolean,
        linkStyle: String,
        xsrfToken: String,
      },

      created: function() {
        this.async(this._refreshAsync, refreshDelayMs);
      },

      ////////////////////// Refresh ///////////////////////////

      _refresh: function() {
        if (!this._refreshEnabled) {
          return;
        }
        this.$.annotations.fetch();
        this.$.bugQueue.refresh();
        this.$.masterRestarts.refresh();
        this.$.treeStatus.refresh();
        this.$.drawer.refresh();
        this._alertsGroupsChanged(this._alertsGroups);
      },

      _refreshAsync: function() {
        this._refresh();
        this.async(this._refreshAsync, refreshDelayMs);
      },

      ////////////////////// Alerts and path ///////////////////////////

      _alertsChanged: function(alerts) {
        if (alerts && alerts.length > 0) {
          document.title = '(' + alerts.length + ') Sheriff-o-Matic';
        } else {
          document.title = 'Sheriff-o-Matic';
        }
      },

      _computeBugQueueLabel: function(tree, trees) {
        if (tree in trees) {
          return trees[tree].bug_queue_label;
        }
        return '';
      },

      _computeHelpLink: function(tree, trees) {
        if (tree in trees) {
          return trees[tree].help_link;
        }
        return '';
      },

      _computeIsTrooperPage: function(tree) {
        return tree === 'trooper';
      },

      _computeShowSwarmingAlerts: function(swarming) {
        return swarming && (swarming.dead || swarming.quarantined);
      },

      _computeTree: function(path) {
        let pathParts = path.split('/');
        if (pathParts.length < 2 || pathParts[1] == '') {
          return '';
        }

        return pathParts[1];
      },

      _computeTreeLogo: function(tree, trees, errored) {
        if (!errored && tree in trees) {
          return `/logos/${tree}`;
        }
        return null;
      },

      _computeTreeDisplayName: function(tree, trees) {
        if (tree in trees) {
          return trees[tree].display_name;
        }
        return tree;
      },

      _treeChanged: function() {
        this._alertsData = {};
        this._fetchedAlerts = false;
      },

      _computeAlertsGroups: function(tree, trees) {
        if (tree === '' || tree in this._staticPages || Object.keys(trees).length == 0) {
          return [];
        }

        if (trees && trees[tree] && trees[tree].alert_streams) {
          return trees[tree].alert_streams
        }

        return [tree];
      },

      _computeRefreshEnabled: function(selectedPage) {
        return selectedPage == 'alertsList';
      },

      _computeSelectedPage: function(path) {
        let pathParts = path.split('/');
        if (pathParts.length < 2 || pathParts[1] == '') {
          // Default page
          return 'help-som';
        }
        if (pathParts.length == 2) {
          if (pathParts[1] in this._staticPages) {
            if (pathParts[1] === 'calendar') {
              // Hide rotation calendar until visited because it's really big.
              this._showRotationCalendar = true;
            }
            return this._staticPages[pathParts[1]].pageId;
          } else {
            // On the page for a tree
            return 'alertsList';
          }
        }
        if (pathParts[2] == 'examine') {
          return 'examineAlert';
        }
      },

      _computeExaminedAlertKey: function(path) {
        let pathParts = path.split('/');
        if (pathParts.length < 2) {
          console.error('error: pathParts < 2', pathParts);
        }

        if (pathParts.length < 3) {
          return '';
        }

        if (pathParts[2] == 'examine') {
          if (pathParts.length > 3) {
            // Let som-examine element deal with the rest of the path.
            return window.unescape(pathParts.slice(3).join('/'));
          }
        }
      },

      _computeExaminedAlert: function(alerts, examinedAlertKey) {
        let examinedAlert = alerts.find( (alert) => {
          return alert.key == examinedAlertKey;
        });
        // Two possibilities if examinedAlert is undefined:
        // 1. The alert key is bad.
        // 2. Alerts has not been ajaxed in yet.
        if (examinedAlert) {
          return examinedAlert;
        }
        return {};
      },

      _computeLastUpdated: function(alertsTimes) {
        alertsTimes = alertsTimes.base;

        // Alert streams are assumed to be always older than right now.
        let oldestDate = new Date();
        Object.keys(alertsTimes).forEach((tree) => {
          if (alertsTimes[tree] < oldestDate) {
            oldestDate = alertsTimes[tree];
          }
        });

        // Assume it takes less than 1 millisecond to calculate that.
        if (Date.now() - oldestDate > 1) {
          return new Date(oldestDate * 1000).toLocaleString(false,
            {timeZoneName: 'short'});
        }
        return 'Unknown';
      },

      _alertsGroupsChanged: function(alertsGroups) {
        this._fetchAlertsError = '';
        if (alertsGroups.length > 0) {
          this._fetchedAlerts = false;
          this._activeRequests += alertsGroups.length;

          alertsGroups.forEach((group) => {
            window.fetch('/api/v1/alerts/' + group, {credentials: 'include'}).then((response) => {
              this._activeRequests -= 1;
              if (response.status == 404) {
                this._fetchAlertsError = 'Server responded with 404: ' + group
                  + ' not found. ';
                return false;
              }
              if (!response.ok) {
                this._fetchAlertsError = 'Server responded with ' + response.status + ': ' + response.statusText;
                return false;
              }
              return response.json();
            }, (error) => {
              this._activeRequests -= 1;
              this._fetchAlertsError = 'Could not connect to the server. '
                + error;
            }).then((json) => {
              if (json) {
                this.set('_swarmingAlerts', json.swarming);
                this.set(['_alertsData', this._alertGroupVarName(group)],
                  json.alerts);
                this.set(['_alertsTimes', this._alertGroupVarName(group)],
                  json.timestamp);
              }
            });
          });
        }
      },

      _alertGroupVarName(group) {
        return group.replace('.', '_');
      },

      _computeFetchingAlerts: function(activeRequests) {
        return activeRequests !== 0;
      },

      _computeAlerts: function(alertsData, annotations, showInfraFailures, isTrooperPage) {
        if (!alertsData || !alertsData.base) {
          return [];
        }
        alertsData = alertsData.base;

        let allAlerts = [];
        for (let tree in alertsData) {
          let alerts = alertsData[tree];
          if (!alerts) {
            continue;
          }
          if (!isTrooperPage && !showInfraFailures) {
            alerts = alerts.filter(function(alert) {
              return alert.type !== 'infra-failure';
            });
          }
          allAlerts = allAlerts.concat(alerts);
        }

        if (!allAlerts) {
          return [];
        }

        allAlerts.sort((a, b) => {
          let aAnn = this.computeAnnotation(annotations, a);
          let bAnn = this.computeAnnotation(annotations, b);

          let aHasBugs = aAnn.bugs && aAnn.bugs.length > 0;
          let bHasBugs = bAnn.bugs && bAnn.bugs.length > 0;

          if (a.severity != b.severity) {
            // Note: 3 is the severity number for Infra Failures.
            // We want these at the bottom of the severities for sheriffs.
            if (a.severity == 3) {
              return 1;
            } else if (b.severity == 3) {
              return -1;
            }
            return a.severity - b.severity;
          }

          if (aAnn.snoozed == bAnn.snoozed && aHasBugs == bHasBugs) {
            if (a.title < b.title) {
              return -1;
            }
            if (a.title > b.title) {
              return 1;
            }
            return 0;
          } else if (aAnn.snoozed == bAnn.snoozed) {
            return aHasBugs ? 1 : -1;
          }

          return aAnn.snoozed ? 1 : -1;
        });

        // Wait for alerts to be loaded
        setTimeout(() => {
          this._fetchedAlerts = true;
        }, 200);
        return allAlerts;
      },


      _computeHideJulie: function(alerts, fetchedAlerts, fetchingAlerts, fetchAlertsError, tree) {
        if (fetchingAlerts || !fetchedAlerts || !alerts || fetchAlertsError !== '' || tree === '') {
          return true;
        }
        return alerts.length > 0;
      },

      ////////////////////// Alert Categories ///////////////////////////

      _alertsWithCategory: function(alerts, category, isTrooperPage) {
        return alerts.filter(function(alert) {
          if (isTrooperPage) {
            return alert.tree == category;
          }
          return alert.severity == category;
        });
      },


      _computeCategories: function(alerts, isTrooperPage) {
        let categories = [];
        alerts.forEach(function(alert) {
          let cat = alert.severity;
          if (isTrooperPage) {
            cat = alert.tree;
          }
          if (!categories.includes(cat)) {
            categories.push(cat);
          }
        });

        return categories;
      },

      _getCategoryTitle: function(category, isTrooperPage) {
        if (isTrooperPage) {
          return this._computeTreeDisplayName(category, this._trees);
        }
        return {
          0: 'Tree closers',
          1: 'Stale masters',
          2: 'Probably hung builders',
          3: 'Infra failures',
          4: 'Consistent failures',
          5: 'New failures',
          6: 'Idle builders',
          7: 'Offline builders',
        }[category];
      },

      ////////////////////// Annotations ///////////////////////////

      collapseAll: function(evt) {
        if (!this.useCompactView) {
          return;
        }

        this.mutateLocalState((newState) => {
          let cat = evt.model.dataHost.dataHost.cat;
          this._alertsWithCategory(this._alerts, cat, this._isTrooperPage).forEach((alr) => {
            newState[alr.key] = Object.assign(newState[alr.key] || {}, {opened: false});
          });
        });
      },

      expandAll: function(evt) {
        if (!this.useCompactView) {
          return;
        }

        this.mutateLocalState((newState) => {
          let cat = evt.model.dataHost.dataHost.cat;
          this._alertsWithCategory(this._alerts, cat, this._isTrooperPage).forEach((alr) => {
            newState[alr.key] = Object.assign(newState[alr.key] || {}, {opened: true});
          });
        });
      },

      _handleOpenedChange: function(evt) {
        this.$.annotations.handleOpenedChange(evt);
      },

      _handleAnnotation: function(evt) {
        this.$.annotations.handleAnnotation(evt);
      },

      _handleComment: function(evt) {
        this.$.annotations.handleComment(evt);
      },

      _handleLinkBug: function(evt) {
        this.$.annotations.handleLinkBug(evt);
      },

      _handleSnooze: function(evt) {
        this.$.annotations.handleSnooze(evt);
      },
    });
  })();
  </script>
</dom-module>
