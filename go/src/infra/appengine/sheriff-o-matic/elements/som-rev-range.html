<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<dom-module id="som-rev-range">
  <template>
    <style>
      .rev-list {
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 20px;
      }
      .commit {
        font-family: monospace;
        font-size: 9pt;
        margin: 1em;
      }
      .suspect-cl {
        color: #FF8C00;
        font-weight: bold;
      }
      .collapse {
        cursor: pointer;
      }
      .header {
        color: #FFFFFF;
      }
      .padding-right {
        padding-right: 0.5em;
      }
    </style>
    <div class="layout horizontal center">
      <span class="padding-right">
        [[range.repo]]: 
      </span>
      <a class="padding-right" target="_blank" href$="[[_regressionRangeLink(range)]]">[[_regressionRange(range)]]</a>
      <div class="collapse layout horizontal center" on-tap="_toggleCollapse">
        Click to see [[_collapseMessage]] information.
        <iron-icon icon="[[_iconName]]"></iron-icon>
      </div>
    </div>
    <iron-collapse id="collapse" class="rev-list" no-animation>
      <template is="dom-repeat" items="[[_revs]]" as="rev">
        <div class="commit">
          <a href$="https://chromium.googlesource.com/chromium/src/+/[[rev.commit]]" target="_blank">
            <span class$="[[_calulateClass(rev, range)]]">[[_shortHash(rev.commit)]]</span>
          </a>
          (<a href$="mailto:[[rev.author.email]]">[[rev.author.name]]</a>):
          [[_firstLine(rev.message)]]
        </div>
      </template>
      <div id="loadingMessage" hidden>Loading revisions...</div>
    </iron-collapse>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'som-rev-range',

      properties: {
        range: {
          type: Object,
          value: null
        },
        _collapseMessage: {
          type: String,
          value: 'more',
        },
        _revs: {
          type: Array,
          value: null
        },
        _iconName: {
          type: String,
          value: 'icons:unfold-more'
        },
      },

      ready: function() {
        this._fetchData();
      },

     _fetchData: function() {
       let start = this._regressionStart(this.range);
       let end = this._regressionEnd(this.range);
       let url = `/api/v1/revrange/${start}/${end}`;
       this.$.loadingMessage.hidden = false;
       fetch(url).then((resp) => {
         resp.text().then((bodyJson) => {
           // remove the )]}' on the first line.
           bodyJson = bodyJson.substr(')]}\'\n'.length);
           let body = JSON.parse(bodyJson);
           this._revs = body.log;
           this.$.loadingMessage.hidden = true;
         }, (reject) => {
           console.error(reject);
         });
       }, (reject) => {
         console.error(reject);
       });
     },

     _toggleCollapse: function() {
       this.$.collapse.toggle();
       this._iconName = this.$.collapse.opened ? 'icons:unfold-less' :
           'icons:unfold-more';
       this._collapseMessage = this.$.collapse.opened ? 'less' : 'more';
     },

     _shortHash: function(hash) {
       return hash.substring(0, 8);
     },

     _firstLine: function(message) {
       return message.split('\n')[0];
     },

     _regressionStart: function(range) {
        if (range && (!range.positions || range.positions.length == 0)) {
          return '';
        }

        return this._parseCommitPosition(range.positions[0]);
     },

     _regressionEnd: function(range) {
        if (!range.positions || range.positions.length == 0) {
          return '';
        }

        return this._parseCommitPosition(
            range.positions[range.positions.length - 1]);
     },

     _regressionRange: function(range) {
        if (!range) {
          return '';
        }

        let start = this._regressionStart(range);
        let end = this._regressionEnd(range);

        if (start && end) {
          return `${start} - ${end}`;
        }

        return start;
      },

      _regressionRangeLink: function(range) {
        if (!range || !range.positions) {
          return '';
        }
        let end = this._parseCommitPosition(range.positions[0]);
        let start = end;
        if (range.positions.length > 1) {
          end = this._parseCommitPosition(
              range.positions[range.positions.length - 1]);
        }
        return 'http://test-results.appspot.com/revision_range?start=' +
            `${start}&end=${end}`;
      },

      _parseCommitPosition: function(pos) {
        let groups = /refs\/heads\/master@{#([0-9]+)}/.exec(pos);
        if (groups && groups.length == 2) {
          return groups[1];
        }
      },

      _isSuspect: function(rev, range) {
        if (range && range.revisions_with_results) {
          for (var i in range.revisions_with_results) {
            let cl = range.revisions_with_results[i];
            if (cl.revision == rev.commit && cl.is_suspect) {
              return true;
            }
          }
        }
        return false;
      },

      _calulateClass: function(rev, range) {
        if (this._isSuspect(rev, range)) {
          return 'suspect-cl';
        }
        return '';
      },
    });
  })();

  </script>
</dom-module>
